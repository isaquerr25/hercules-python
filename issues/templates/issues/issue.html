{% load static htmx_csrf_token %}

<link rel="stylesheet" href="{% static 'vendor/quilljs/quill.snow.css' %}">
<script src="{% static 'vendor/quilljs/quill.min.js' %}"></script>
<script>
    toolbarOptions = [
        ['bold', 'italic', 'underline', 'strike'],        // toggled buttons
        ['blockquote', 'code-block'],

        [{ 'header': 1 }, { 'header': 2 }],               // custom button values
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        [{ 'script': 'sub'}, { 'script': 'super' }],      // superscript/subscript
        [{ 'indent': '-1'}, { 'indent': '+1' }],          // outdent/indent
        [{ 'direction': 'rtl' }],                         // text direction

        [{ 'size': ['small', false, 'large', 'huge'] }],  // custom dropdown
        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],

        [{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
        [{ 'font': [] }],
        [{ 'align': [] }],

        ['image'],                                        // image

        ['clean'],                                        // remove formatting button
    ];
    quillOptions =  {
        theme: 'snow',
        modules: {
            toolbar: toolbarOptions
        },
    };
</script>

<div
    {% block container_classes %} class="grid grid-cols-[1fr_15rem] gap-4 w-full h-full" {% endblock %}
>
    <div class="flex flex-col gap-4 overflow-y-auto mr-[-1rem] pr-4">
        <div
            id="issue-header"
            class="flex flex-row gap-4 relative rounded-xl bg-white w-full p-4"
        >
            <h1 class="group flex-1 text-green-800 text-3xl font-bold flex flex-row justify-start items-center gap-2">
                {% block issue_header %}
                    {% if issue.created_by == request.user or request.selected_project.can_rename_issues %}
                        {% if renaming|default:False %}
                            <input
                                name="issue-title"
                                id="issue-title-input"
                                value="{{ issue.title }}"
                                class="bg-transparent border-transparent border-0 border-b text-3xl p-0 m-0 outline-none focus:border-b-green-800 transition"
                                size={{ issue.title|length }}
                                oninput="this.size = this.value.length"
                                onfocus="var temp_value=this.value; this.value=''; this.value=temp_value;"
                                autofocus
                            >
                            <button
                                class="md:opacity-0 group-focus-within:opacity-100 group-hover:opacity-100 h-8 w-8 rounded-full inline-flex justify-center items-center text-lg text-cyan-700 bg-cyan-700 bg-opacity-0 hover:bg-opacity-30 transition"
                                hx-put="{% url 'issues:rename' issue.number %}"
                                hx-swap="outerHTML"
                                hx-target="#issue-header"
                                hx-select="#issue-header"
                                hx-include="#issue-title-input"
                                hx-trigger="click, keydown[key=='Enter'] from:#issue-title-input"
                                {% htmx_csrf_token %}
                                title="Rename Issue"
                            >
                                <i class="fa-solid fa-floppy-disk"></i>
                            </button>
                        {% else %}
                            {{ issue.title }}
                            <button
                                class="md:opacity-0 group-focus-within:opacity-100 group-hover:opacity-100 h-8 w-8 rounded-full inline-flex justify-center items-center text-lg text-cyan-700 bg-cyan-700 bg-opacity-0 hover:bg-opacity-30 transition"
                                hx-get="{% url 'issues:rename' issue.number %}"
                                hx-swap="outerHTML"
                                hx-target="#issue-header"
                                hx-select="#issue-header"
                                title="Rename Issue"
                            >
                                <i class="fa-solid fa-pen"></i>
                            </button>
                        {% endif %}
                    {% else %}
                        {{ issue.title }}
                    {% endif %}
                {% endblock %}
            </h1>
        </div>

        {% block change_history %}
            {% for change in history %}
                {% include 'issues/change.html' with oob=False %}
            {% endfor %}
        {% endblock %}

        {% block new_comment %}
            <div id="new-comment-container" class="flex flex-col relative rounded-xl bg-white w-full p-4 min-h-[30rem]">
                <h2 class="text-green-800 font-bold text-lg">Add comment</h2>
                <div id="new-comment-editor"></div>

                <div class="flex flex-row justify-end mt-4">
                    <button
                        class="bg-green-800 hover:bg-green-700 text-white text-xl font-bold px-8 py-1 rounded-2xl"
                        onclick="triggerCommentSubmit();"
                    >Save</button>
                </div>
                <form
                    id="new-comment-form"
                    hx-post="{% url 'issues:comment' issue.number %}"
                    hx-trigger="issues:createNewComment from:body"
                    hx-vals="js:{comment: getCommentContent()}"
                >
                    {% csrf_token %}
                </form>
            </div>

            <script defer>
                commentQuill = null;

                function setupCommentQuill() {
                    commentQuill = new Quill('#new-comment-editor', quillOptions);
                }

                cqInterval = null;
                cqInterval = setInterval(() => {
                    if (window.Quill != undefined) {
                        clearInterval(cqInterval);
                        setupCommentQuill();
                    }
                }, window.Quill == undefined ? 50 : 0)

                function getCommentContent() {
                    return commentQuill.getContents();
                }

                function triggerCommentSubmit() {
                    const text = commentQuill.getText();
                    const length = commentQuill.getLength();

                    if ((text === '' || text === '\n') && length <= 1) {
                        swal.fire({
                            icon: 'error',
                            title: "The comment can't be empty",
                            showConfirmButton: true,
                            confirmButtonText: "Ok",
                            heightAuto: false,
                        });
                        return;
                    }

                    document.body.dispatchEvent(new Event('issues:createNewComment'));
                }
            </script>
        {% endblock %}
    </div>

    {% block issue_sidebar %}
        <div
            class="flex flex-row gap-4 relative rounded-xl bg-white w-full p-4"
        >
        </div>
    {% endblock %}
</div> 

